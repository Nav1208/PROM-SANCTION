<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="sslg.png" />
  <title>Attendance Sanction</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { mono: ['Space Mono','monospace'], sans: ['DM Sans','sans-serif'] },
          colors: { brand: { 50:'#fff7ed',100:'#ffedd5',400:'#fb923c',500:'#f97316',600:'#ea580c',700:'#c2410c' } }
        }
      }
    }
  </script>
  <tag><!--Nag pa help ako sa AI So hard men--></tag>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { font-family:'DM Sans',sans-serif; overscroll-behavior:none; }
    ::-webkit-scrollbar { width:4px; height:4px }
    ::-webkit-scrollbar-thumb { background:#f97316; border-radius:99px }

    /* Toast â€” centered top for mobile */
    #toast-container { position:fixed; top:max(env(safe-area-inset-top,0px),12px); left:50%; transform:translateX(-50%); z-index:9999; display:flex; flex-direction:column; gap:.4rem; pointer-events:none; width:calc(100% - 2rem); max-width:340px; }
    .toast { pointer-events:auto; padding:.7rem 1rem; border-radius:1rem; font-size:.82rem; font-weight:600; color:#fff; animation:slideDown .25s ease; box-shadow:0 8px 32px rgba(0,0,0,.28); text-align:center; }
    .toast.success{background:#16a34a}.toast.error{background:#dc2626}.toast.info{background:#2563eb}
    @keyframes slideDown{from{transform:translateY(-16px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes fadeOut{to{opacity:0;transform:translateY(-12px)}}

    /* Spinner */
    .spinner{border:3px solid rgba(249,115,22,.2);border-top-color:#f97316;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Tabs */
    .tab-panel{display:none}.tab-panel.active{display:block}
    .nav-tab{transition:color .15s,border-color .15s;border-bottom:3px solid transparent;flex-shrink:0}
    .nav-tab.active{color:#f97316;border-bottom-color:#f97316}

    /* Badges */
    .badge-cleared{background:#dcfce7;color:#15803d}
    .badge-balance{background:#fee2e2;color:#b91c1c}
    .dark .badge-cleared{background:#14532d;color:#86efac}
    .dark .badge-balance{background:#450a0a;color:#fca5a5}

    /* Stat card tap effect */
    .stat-card{transition:transform .1s;cursor:default}
    .stat-card:active{transform:scale(.97)}

    /* Modal bg */
    .modal-bg{background:rgba(0,0,0,.65);backdrop-filter:blur(6px)}

    /* Grade pills */
    .pill-g11{background:#dbeafe;color:#1d4ed8}.dark .pill-g11{background:#1e3a5f;color:#93c5fd}
    .pill-g12{background:#ede9fe;color:#6d28d9}.dark .pill-g12{background:#3b1f6b;color:#c4b5fd}
    .pill-unspec{background:#f1f5f9;color:#64748b}.dark .pill-unspec{background:#334155;color:#94a3b8}

    /* Filter pill buttons */
    .filter-btn{transition:all .15s;border:2px solid transparent;font-weight:700}
    .filter-btn.active{background:#f97316;color:#fff;border-color:#f97316}
    .filter-btn:not(.active){background:transparent;border-color:#e2e8f0;color:#64748b}
    .dark .filter-btn:not(.active){border-color:#475569;color:#94a3b8}
    .filter-btn:active{transform:scale(.95)}

    /* Grade picker buttons in modal */
    .grade-btn{border:2px solid #e2e8f0;transition:all .15s;font-weight:700}
    .dark .grade-btn{border-color:#475569;color:#94a3b8}
    .grade-btn.sel-g11{border-color:#3b82f6;background:#eff6ff;color:#1d4ed8}
    .grade-btn.sel-g12{border-color:#8b5cf6;background:#f5f3ff;color:#6d28d9}
    .grade-btn.sel-un{border-color:#94a3b8;background:#f8fafc;color:#475569}
    .dark .grade-btn.sel-g11{background:#1e3a5f;color:#93c5fd}
    .dark .grade-btn.sel-g12{background:#3b1f6b;color:#c4b5fd}
    .dark .grade-btn.sel-un{background:#334155;color:#94a3b8}

    /* Animations */
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.85}}

    /* Watermark */
    #app::before{content:'';position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:280px;height:280px;background-image:url('sslg.png');background-size:contain;background-repeat:no-repeat;background-position:center;opacity:.05;pointer-events:none;z-index:0}
    main{position:relative;z-index:1}

    /* Safe area */
    .safe-bottom{padding-bottom:env(safe-area-inset-bottom,0)}

    /* Prevent iOS zoom on inputs */
    input,select,textarea{font-size:16px!important}

    /* Touch-friendly min height for buttons */
    button{min-height:40px;cursor:pointer}

    /* Horizontal scroll for attendance table */
    .h-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}

    /* Attendance card collapse */
    .att-body{transition:max-height .3s ease,opacity .2s ease;overflow:hidden}
    .att-body.collapsed{max-height:0!important;opacity:0}

    /* Hide scrollbar for filter rows */
    .no-scrollbar{scrollbar-width:none;-ms-overflow-style:none}
    .no-scrollbar::-webkit-scrollbar{display:none}

    table{border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;z-index:1}
  </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-300">

<div id="toast-container"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â• LOADING OVERLAY â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900">
  <div class="flex flex-col items-center gap-4" style="animation:fadeInUp .6s ease forwards">
    <img src="sslg.png" alt="SSLG Logo" style="width:130px;height:130px;object-fit:contain;animation:pulse 1.5s ease-in-out infinite"/>
    <p class="text-white font-mono text-sm tracking-widest">Wait lang Teh</p>
    <div class="spinner" style="width:1.5rem;height:1.5rem;border-width:3px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• RESET ALL MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="reset-all-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-bg">
  <div class="bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl p-5 w-full max-w-sm safe-bottom">
    <div class="w-10 h-1 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-4 sm:hidden"></div>
    <div class="flex items-center gap-3 mb-2">
      <div class="w-10 h-10 rounded-xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-xl flex-shrink-0">âš ï¸</div>
      <h3 class="text-base font-bold text-red-500">Reset All Records</h3>
    </div>
    <p class="text-slate-500 dark:text-slate-400 text-sm mb-4">This permanently resets <strong>ALL</strong> sanctions, attendance, and payments. Cannot be undone.</p>
    <label class="block text-xs font-mono text-slate-500 uppercase tracking-widest mb-1">Admin Password</label>
    <input id="reset-all-password" type="password" placeholder="Password to confirm" autocomplete="current-password"
      class="w-full border border-red-300 dark:border-red-700 rounded-xl px-4 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-red-400 mb-1"/>
    <p id="reset-all-error" class="text-red-500 text-xs mb-3 hidden">âŒ Incorrect password.</p>
    <div class="flex gap-3">
      <button id="reset-all-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-600 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-700 transition">Cancel</button>
      <button id="reset-all-confirm" class="flex-1 py-3 rounded-xl bg-red-500 text-white text-sm font-bold hover:bg-red-600 transition">Reset All</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• CONFIRM MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-bg">
  <div class="bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl p-5 w-full max-w-sm safe-bottom">
    <div class="w-10 h-1 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-4 sm:hidden"></div>
    <h3 class="text-base font-bold mb-2">Confirm Action</h3>
    <p id="confirm-text" class="text-slate-500 dark:text-slate-400 text-sm mb-5"></p>
    <div class="flex gap-3">
      <button id="confirm-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-600 text-sm font-semibold">Cancel</button>
      <button id="confirm-ok" class="flex-1 py-3 rounded-xl bg-red-500 text-white text-sm font-bold hover:bg-red-600 transition">Confirm</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PAYMENT MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="payment-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-bg">
  <div class="bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl p-5 w-full max-w-sm safe-bottom">
    <div class="w-10 h-1 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-4 sm:hidden"></div>
    <h3 class="text-base font-bold mb-1">Record Payment</h3>
    <p id="payment-name" class="text-sm text-brand-500 font-bold mb-4"></p>
    <label class="block text-xs font-mono text-slate-500 uppercase tracking-widest mb-1">Amount (â‚±)</label>
    <input id="payment-amount" type="number" min="1" placeholder="0.00" inputmode="decimal"
      class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500 mb-4"/>
    <div class="flex gap-3">
      <button id="payment-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-600 text-sm font-semibold">Cancel</button>
      <button id="payment-ok" class="flex-1 py-3 rounded-xl bg-brand-500 text-white text-sm font-bold hover:bg-brand-600 transition">Record</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• STUDENT MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="student-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-bg">
  <div class="bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl p-5 w-full max-w-md max-h-[93vh] overflow-y-auto safe-bottom">
    <div class="w-10 h-1 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-4 sm:hidden"></div>
    <h3 id="student-modal-title" class="text-base font-bold mb-4">Add Student</h3>

    <label class="block text-xs font-mono text-slate-500 uppercase tracking-widest mb-1">Student Name</label>
    <input id="student-name-input" type="text" placeholder="Full name" autocomplete="off"
      class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500 mb-4"/>

    <label class="block text-xs font-mono text-slate-500 uppercase tracking-widest mb-2">Grade Level</label>
    <div class="grid grid-cols-3 gap-2 mb-5">
      <button type="button" class="grade-btn py-3 rounded-xl text-sm text-center" data-level="Grade 11">Grade 11</button>
      <button type="button" class="grade-btn py-3 rounded-xl text-sm text-center" data-level="Grade 12">Grade 12</button>
      <button type="button" class="grade-btn py-3 rounded-xl text-xs text-center" data-level="Unspecified">Unspecified</button>
    </div>
    <input type="hidden" id="student-grade-input" value="Unspecified"/>

    <!-- Edit-only section -->
    <div id="edit-sanctions-section" class="hidden">
      <div class="border-t border-slate-200 dark:border-slate-700 pt-4 mb-4">
        <p class="text-xs font-mono text-slate-500 uppercase tracking-widest mb-3">Override Sanctions</p>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="block text-xs font-medium text-slate-500 mb-1">Late Count</label>
            <input id="edit-late-input" type="number" min="0" placeholder="0" inputmode="numeric"
              class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-3 bg-white dark:bg-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 mb-1">Absent Count</label>
            <input id="edit-absent-input" type="number" min="0" placeholder="0" inputmode="numeric"
              class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-3 bg-white dark:bg-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-red-400"/>
          </div>
        </div>
        <div class="mb-3">
          <label class="block text-xs font-medium text-slate-500 mb-1">Total Paid (â‚±)</label>
          <input id="edit-paid-input" type="number" min="0" placeholder="0" inputmode="decimal"
            class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-3 bg-white dark:bg-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"/>
        </div>
        <div id="edit-sanction-preview" class="text-xs text-slate-400 font-mono bg-slate-50 dark:bg-slate-700/50 rounded-xl px-3 py-2.5 mb-3 leading-relaxed"></div>
        <button id="reset-sanctions-btn" class="w-full py-3 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-500 text-xs font-bold hover:bg-red-100 dark:hover:bg-red-900/40 transition border border-red-200 dark:border-red-800">
          â†© Reset All Sanctions to Zero
        </button>
      </div>
    </div>

    <div class="flex gap-3">
      <button id="student-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-600 text-sm font-semibold">Cancel</button>
      <button id="student-ok" class="flex-1 py-3 rounded-xl bg-brand-500 text-white text-sm font-bold hover:bg-brand-600 transition">Save</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-panel" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-bg">
  <div class="bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl p-5 w-full max-w-sm safe-bottom">
    <div class="w-10 h-1 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-4 sm:hidden"></div>
    <div class="flex items-center gap-3 mb-5">
      <div class="w-10 h-10 rounded-xl overflow-hidden flex-shrink-0"><img src="sslg.png" alt="SSLG" class="w-full h-full object-contain"/></div>
      <h2 class="text-lg font-bold">Admin Login</h2>
    </div>
    <input id="login-email" type="email" placeholder="Email" autocomplete="email" inputmode="email"
      class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500 mb-3"/>
    <input id="login-password" type="password" placeholder="Password" autocomplete="current-password"
      class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500 mb-4"/>
    <button id="login-submit" class="w-full py-3.5 rounded-xl bg-brand-500 text-white font-bold hover:bg-brand-600 transition mb-3">Sign In</button>
    <button id="login-cancel" class="w-full py-3 rounded-xl border border-slate-200 dark:border-slate-600 text-sm font-semibold">Cancel</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" class="hidden min-h-screen flex flex-col">

  <!-- STICKY HEADER -->
  <header class="sticky top-0 z-40 bg-white/90 dark:bg-slate-900/90 backdrop-blur-lg border-b border-slate-200 dark:border-slate-700">
    <div class="max-w-2xl mx-auto px-4 py-2.5 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2 min-w-0">
        <div class="w-8 h-8 rounded-lg overflow-hidden flex-shrink-0"><img src="sslg.png" alt="SSLG" class="w-full h-full object-contain"/></div>
        <div class="min-w-0">
          <h1 class="font-bold text-sm leading-tight truncate">Attendance &amp; Sanctions</h1>
          <p id="header-role" class="text-xs text-slate-400 dark:text-slate-500 font-mono leading-tight truncate">Public View</p>
        </div>
      </div>
      <div class="flex items-center gap-1.5 flex-shrink-0">
        <button id="dark-toggle" title="Toggle dark mode"
          class="w-9 h-9 rounded-xl border border-slate-200 dark:border-slate-600 flex items-center justify-center text-slate-500 dark:text-slate-400">
          <svg id="icon-moon" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
          <svg id="icon-sun" class="w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>
        </button>
        <button id="login-btn" class="px-3 py-2 rounded-xl bg-brand-500 text-white text-xs font-bold">Login</button>
        <button id="logout-btn" class="hidden px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 text-xs font-semibold">Logout</button>
      </div>
    </div>
    <!-- NAV -->
    <div class="max-w-2xl mx-auto px-3 flex no-scrollbar overflow-x-auto border-t border-slate-100 dark:border-slate-800">
      <button class="nav-tab active px-4 py-2.5 text-xs font-semibold whitespace-nowrap" data-tab="dashboard">ğŸ“Š Dashboard</button>
      <button class="nav-tab px-4 py-2.5 text-xs font-semibold whitespace-nowrap" data-tab="attendance">ğŸ“‹ Attendance</button>
      <button class="nav-tab px-4 py-2.5 text-xs font-semibold whitespace-nowrap" data-tab="sanctions">ğŸ’¸ Sanctions</button>
      <button class="nav-tab px-4 py-2.5 text-xs font-semibold whitespace-nowrap" data-tab="leaderboard">ğŸ† Board</button>
      <button class="nav-tab admin-only hidden px-4 py-2.5 text-xs font-semibold whitespace-nowrap" data-tab="students">ğŸ‘¥ Students</button>
    </div>
  </header>

  <main class="flex-1 max-w-2xl mx-auto w-full px-3 py-4 space-y-0">

    <!-- â•â•â•â• DASHBOARD â•â•â•â• -->
    <div id="tab-dashboard" class="tab-panel active">
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="stat-card bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-100 dark:border-slate-700 shadow-sm">
          <p class="text-xs font-mono text-slate-400 uppercase tracking-widest mb-1">Students</p>
          <p id="stat-students" class="text-2xl font-bold font-mono text-brand-500">0</p>
        </div>
        <div class="stat-card bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-100 dark:border-slate-700 shadow-sm">
          <p class="text-xs font-mono text-slate-400 uppercase tracking-widest mb-1">Sanctions</p>
          <p id="stat-sanctions" class="text-2xl font-bold font-mono text-red-500">â‚±0</p>
        </div>
        <div class="stat-card bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-100 dark:border-slate-700 shadow-sm">
          <p class="text-xs font-mono text-slate-400 uppercase tracking-widest mb-1">Collected</p>
          <p id="stat-collected" class="text-2xl font-bold font-mono text-green-500">â‚±0</p>
        </div>
        <div class="stat-card bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-100 dark:border-slate-700 shadow-sm">
          <p class="text-xs font-mono text-slate-400 uppercase tracking-widest mb-1">Outstanding</p>
          <p id="stat-outstanding" class="text-2xl font-bold font-mono text-amber-500">â‚±0</p>
        </div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm p-4">
        <h2 class="font-bold text-sm mb-3">Top Sanctions</h2>
        <div class="relative h-48"><canvas id="sanctions-chart"></canvas></div>
      </div>
    </div>

    <!-- â•â•â•â• ATTENDANCE â•â•â•â• -->
    <div id="tab-attendance" class="tab-panel">

      <!-- Add session (admin) -->
      <div id="add-date-section" class="hidden mb-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm p-4">
          <p class="text-xs font-mono text-slate-500 uppercase tracking-widest mb-3">â• New Practice Session</p>
          <div class="space-y-3">
            <div>
              <label class="block text-xs text-slate-500 mb-1">Date</label>
              <input id="new-date-input" type="date" class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500"/>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-slate-500 mb-1">Time <span class="text-slate-400 normal-case">(optional)</span></label>
                <input id="new-time-input" type="time" class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500"/>
              </div>
              <div>
                <label class="block text-xs text-slate-500 mb-1">Session Label</label>
                <input id="new-session-label" type="text" placeholder="AM / PM / etc." class="w-full border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-3 bg-white dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500"/>
              </div>
            </div>
            <button id="add-date-btn" class="w-full py-3 rounded-xl bg-brand-500 text-white text-sm font-bold hover:bg-brand-600 transition">+ Add Session</button>
          </div>
          <p class="text-xs text-slate-400 mt-2 text-center">ğŸ’¡ Same date + different label = double session (AM &amp; PM)</p>
        </div>
      </div>

      <div id="dates-container" class="space-y-3"></div>
      <p id="no-dates-msg" class="hidden text-center py-12 text-slate-400 font-mono text-sm">No practice dates yet.</p>
    </div>

    <!-- â•â•â•â• SANCTIONS â•â•â•â• -->
    <div id="tab-sanctions" class="tab-panel">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-bold text-base">Sanctions &amp; Payments</h2>
        <button id="export-btn" class="px-3 py-2 rounded-xl border border-brand-500 text-brand-600 dark:text-brand-400 text-xs font-bold flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
          CSV
        </button>
      </div>
      <div class="space-y-2 mb-3">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z"/></svg>
          <input id="sanctions-search" type="search" placeholder="Search studentsâ€¦"
            class="w-full pl-9 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500"/>
        </div>
        <div class="flex gap-2 no-scrollbar overflow-x-auto pb-1">
          <button class="sn-filter filter-btn active rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="all">All</button>
          <button class="sn-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Grade 11">Grade 11</button>
          <button class="sn-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Grade 12">Grade 12</button>
          <button class="sn-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Unspecified">Unspecified</button>
        </div>
        <div class="flex gap-2 no-scrollbar overflow-x-auto pb-1">
          <button class="sn-status filter-btn active rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-status="all">All Status</button>
          <button class="sn-status filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-status="late">&#9200; Has Late</button>
          <button class="sn-status filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-status="absent">&#10060; Has Absent</button>
          <button class="sn-status filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-status="balance">&#128184; With Balance</button>
          <button class="sn-status filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-status="cleared">&#9989; Cleared</button>
        </div>
      </div>
      <div id="sanctions-list" class="space-y-2"></div>
    </div>

    <!-- â•â•â•â• LEADERBOARD â•â•â•â• -->
    <div id="tab-leaderboard" class="tab-panel">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-bold text-base">ğŸ† Leaderboard</h2>
      </div>
      <div class="flex gap-2 mb-4 no-scrollbar overflow-x-auto pb-1">
        <button class="lb-filter filter-btn active rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="all">All</button>
        <button class="lb-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Grade 11">Grade 11</button>
        <button class="lb-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Grade 12">Grade 12</button>
        <button class="lb-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Unspecified">Unspecified</button>
      </div>
      <div id="leaderboard-list" class="space-y-2"></div>
    </div>

    <!-- â•â•â•â• STUDENTS â•â•â•â• -->
    <div id="tab-students" class="tab-panel">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-bold text-base">Students</h2>
        <div class="flex gap-2">
          <button id="reset-all-btn" class="admin-only hidden px-3 py-2 rounded-xl bg-red-500 text-white text-xs font-bold">â†º Reset</button>
          <button id="add-student-btn" class="px-3 py-2 rounded-xl bg-brand-500 text-white text-xs font-bold">+ Add</button>
        </div>
      </div>
      <div class="space-y-2 mb-3">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z"/></svg>
          <input id="student-search" type="search" placeholder="Search studentsâ€¦"
            class="w-full pl-9 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500"/>
        </div>
        <div class="flex gap-2 no-scrollbar overflow-x-auto pb-1">
          <button class="st-filter filter-btn active rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="all">All</button>
          <button class="st-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Grade 11">Grade 11</button>
          <button class="st-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Grade 12">Grade 12</button>
          <button class="st-filter filter-btn rounded-xl px-4 py-2 text-xs whitespace-nowrap" data-grade="Unspecified">Unspecified</button>
        </div>
      </div>
      <div id="students-list" class="space-y-2"></div>
    </div>

  </main>

  <footer class="text-center py-4 text-xs text-slate-400 font-mono safe-bottom">Attendance Ni Ate Mo</footer>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• STUDENT PROFILE MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="profile-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-bg">
  <div class="bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl w-full max-w-sm max-h-[88vh] flex flex-col safe-bottom">
    <!-- Handle -->
    <div class="flex-shrink-0 pt-3 pb-1 px-5">
      <div class="w-10 h-1 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-3 sm:hidden"></div>
      <div class="flex items-start justify-between gap-2">
        <div>
          <h3 id="profile-name" class="text-base font-bold leading-tight"></h3>
          <div id="profile-meta" class="flex items-center gap-1.5 mt-1 flex-wrap"></div>
        </div>
        <button id="profile-close" class="w-8 h-8 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-500 text-sm flex-shrink-0">âœ•</button>
      </div>
      <!-- Summary pills -->
      <div id="profile-summary" class="grid grid-cols-4 gap-2 mt-3"></div>
      <!-- Tabs inside modal -->
      <div class="flex gap-0 mt-3 border-b border-slate-100 dark:border-slate-700">
        <button class="profile-tab-btn active flex-1 py-2 text-xs font-bold border-b-2 border-brand-500 text-brand-500" data-ptab="all">All</button>
        <button class="profile-tab-btn flex-1 py-2 text-xs font-bold border-b-2 border-transparent text-slate-400" data-ptab="late">&#9200; Late</button>
        <button class="profile-tab-btn flex-1 py-2 text-xs font-bold border-b-2 border-transparent text-slate-400" data-ptab="absent">&#10060; Absent</button>
        <button class="profile-tab-btn flex-1 py-2 text-xs font-bold border-b-2 border-transparent text-slate-400" data-ptab="present">&#9989; Present</button>
      </div>
    </div>
    <!-- Scrollable list -->
    <div id="profile-records" class="flex-1 overflow-y-auto px-5 py-3 space-y-2"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyCtXBrH_48U34jw_KrbAZSCpXTY2qfSqEg",
  authDomain: "areyouatecha.firebaseapp.com",
  projectId: "areyouatecha",
  storageBucket: "areyouatecha.firebasestorage.app",
  messagingSenderId: "628406103719",
  appId: "1:628406103719:web:6d1f336ee0a79e877f3582"
});
const auth = firebase.auth();
const db   = firebase.firestore();

let isAdmin          = false;
let students         = [];
let practiceDates    = [];
let attendanceMap    = {};
let sanctionsChart   = null;
let editingStudentId = null;
let payingStudentId  = null;
let pendingConfirm   = null;
let lbGradeFilter    = 'all';
let stGradeFilter    = 'all';
let snGradeFilter    = 'all';
let snStatusFilter   = 'all';

/* â”€â”€ THEME â”€â”€ */
(function(){
  var s = localStorage.getItem('theme');
  if(s==='dark'||(!s&&window.matchMedia('(prefers-color-scheme:dark)').matches)){
    document.documentElement.classList.add('dark');
    document.getElementById('icon-moon').classList.add('hidden');
    document.getElementById('icon-sun').classList.remove('hidden');
  }
})();

/* â”€â”€ LOADER â”€â”€ */
function fadeOutLoader(){
  if(fadeOutLoader.called) return; fadeOutLoader.called=true;
  var o=document.getElementById('loading-overlay');
  o.style.transition='opacity .8s ease'; o.style.opacity='0';
  setTimeout(function(){ hideLoading(); showApp(); },800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM READY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('DOMContentLoaded',function(){
  document.getElementById('new-date-input').value=new Date().toISOString().split('T')[0];

  /* Dark mode */
  document.getElementById('dark-toggle').onclick=function(){
    var d=document.documentElement.classList.toggle('dark');
    document.getElementById('icon-moon').classList.toggle('hidden',d);
    document.getElementById('icon-sun').classList.toggle('hidden',!d);
    localStorage.setItem('theme',d?'dark':'light');
    setTimeout(renderChart,80);
  };

  /* Auth */
  document.getElementById('login-btn').onclick=function(){showModal('login-panel');};
  document.getElementById('login-cancel').onclick=function(){hideModal('login-panel');};
  document.getElementById('login-submit').onclick=doLogin;
  document.getElementById('login-password').onkeydown=function(e){if(e.key==='Enter')doLogin();};
  document.getElementById('logout-btn').onclick=doLogout;

  /* Attendance */
  document.getElementById('add-date-btn').onclick=addPracticeDate;

  /* Reset all */
  document.getElementById('reset-all-btn').onclick=openResetAllModal;
  document.getElementById('reset-all-cancel').onclick=function(){
    hideModal('reset-all-modal');
    document.getElementById('reset-all-error').classList.add('hidden');
    document.getElementById('reset-all-password').value='';
  };
  document.getElementById('reset-all-confirm').onclick=submitResetAll;
  document.getElementById('reset-all-password').onkeydown=function(e){if(e.key==='Enter')submitResetAll();};

  /* Export */
  document.getElementById('export-btn').onclick=exportCSV;

  /* Students */
  document.getElementById('add-student-btn').onclick=openAddStudent;
  document.getElementById('student-search').oninput=renderStudentsTab;

  /* Student modal */
  document.getElementById('student-cancel').onclick=function(){hideModal('student-modal');};
  document.getElementById('student-ok').onclick=submitStudent;
  document.getElementById('student-name-input').onkeydown=function(e){if(e.key==='Enter')submitStudent();};
  document.getElementById('edit-late-input').oninput=updateSanctionPreview;
  document.getElementById('edit-absent-input').oninput=updateSanctionPreview;
  document.getElementById('edit-paid-input').oninput=updateSanctionPreview;
  document.getElementById('reset-sanctions-btn').onclick=function(){if(editingStudentId)resetStudentSanctions(editingStudentId);};

  /* Grade picker */
  document.querySelectorAll('.grade-btn').forEach(function(btn){
    btn.addEventListener('click',function(){
      document.getElementById('student-grade-input').value=btn.dataset.level;
      setGradePickerUI(btn.dataset.level);
    });
  });

  /* Payment */
  document.getElementById('payment-cancel').onclick=function(){hideModal('payment-modal');};
  document.getElementById('payment-ok').onclick=submitPayment;
  document.getElementById('payment-amount').onkeydown=function(e){if(e.key==='Enter')submitPayment();};

  /* Profile modal */
  document.getElementById('profile-close').onclick=function(){hideModal('profile-modal');};
  document.getElementById('profile-modal').addEventListener('click',function(e){
    if(e.target===this)hideModal('profile-modal');
  });
  document.querySelectorAll('.profile-tab-btn').forEach(function(btn){
    btn.addEventListener('click',function(){
      document.querySelectorAll('.profile-tab-btn').forEach(function(b){
        b.classList.remove('active','border-brand-500','text-brand-500');
        b.classList.add('border-transparent','text-slate-400');
      });
      btn.classList.add('active','border-brand-500','text-brand-500');
      btn.classList.remove('border-transparent','text-slate-400');
      renderProfileRecords(btn.dataset.ptab);
    });
  });

  /* Confirm */
  document.getElementById('confirm-cancel').onclick=function(){hideModal('confirm-modal');pendingConfirm=null;};
  document.getElementById('confirm-ok').onclick=function(){
    hideModal('confirm-modal');
    if(pendingConfirm){var fn=pendingConfirm;pendingConfirm=null;fn();}
  };

  /* Nav tabs */
  document.querySelectorAll('.nav-tab').forEach(function(btn){
    btn.onclick=function(){switchTab(btn.dataset.tab);};
  });

  /* Leaderboard grade filter */
  document.querySelectorAll('.lb-filter').forEach(function(btn){
    btn.addEventListener('click',function(){
      lbGradeFilter=btn.dataset.grade;
      document.querySelectorAll('.lb-filter').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      renderLeaderboard();
    });
  });

  /* Sanctions search & grade filter */
  document.getElementById('sanctions-search').oninput=renderSanctions;
  document.querySelectorAll('.sn-filter').forEach(function(btn){
    btn.addEventListener('click',function(){
      snGradeFilter=btn.dataset.grade;
      document.querySelectorAll('.sn-filter').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      renderSanctions();
    });
  });
  document.querySelectorAll('.sn-status').forEach(function(btn){
    btn.addEventListener('click',function(){
      snStatusFilter=btn.dataset.status;
      document.querySelectorAll('.sn-status').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      renderSanctions();
    });
  });

  /* Students grade filter */
  document.querySelectorAll('.st-filter').forEach(function(btn){
    btn.addEventListener('click',function(){
      stGradeFilter=btn.dataset.grade;
      document.querySelectorAll('.st-filter').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      renderStudentsTab();
    });
  });

  /* Event delegation */
  document.getElementById('dates-container').addEventListener('click',onAttendanceClick);
  document.getElementById('sanctions-list').addEventListener('click',onSanctionsClick);
  document.getElementById('students-list').addEventListener('click',onStudentsClick);

  /* Firebase auth */
  auth.onAuthStateChanged(function(user){
    isAdmin=!!user;
    updateAuthUI(user);
    setTimeout(fadeOutLoader,3000);
  });

  listenStudents();
  listenPracticeDates();
  listenAttendance();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateAuthUI(user){
  if(user){
    document.getElementById('login-btn').classList.add('hidden');
    document.getElementById('logout-btn').classList.remove('hidden');
    document.getElementById('header-role').textContent='ğŸ”‘ '+user.email;
    document.querySelectorAll('.admin-only').forEach(function(el){el.classList.remove('hidden');});
    document.getElementById('add-date-section').classList.remove('hidden');
  } else {
    document.getElementById('login-btn').classList.remove('hidden');
    document.getElementById('logout-btn').classList.add('hidden');
    document.getElementById('header-role').textContent='Public View';
    document.querySelectorAll('.admin-only').forEach(function(el){el.classList.add('hidden');});
    document.getElementById('add-date-section').classList.add('hidden');
  }
}
async function doLogin(){
  var email=document.getElementById('login-email').value.trim();
  var pass=document.getElementById('login-password').value;
  if(!email||!pass){toast('Enter email and password.','error');return;}
  showLoading();
  try{ await auth.signInWithEmailAndPassword(email,pass); hideModal('login-panel'); toast('Logged in!','success'); }
  catch(e){ toast('Login failed: '+e.message,'error'); }
  hideLoading();
}
async function doLogout(){ await auth.signOut(); toast('Logged out.','info'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIRESTORE LISTENERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function listenStudents(){
  db.collection('students').orderBy('name').onSnapshot(function(snap){
    students=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    renderAll();
  },function(e){console.error('Students:',e);});
}
function listenPracticeDates(){
  db.collection('practiceDates').orderBy('date').onSnapshot(function(snap){
    practiceDates=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    renderAttendanceTab();
  },function(e){console.error('PracticeDates:',e);});
}
function listenAttendance(){
  db.collection('attendance').onSnapshot(function(snap){
    attendanceMap={};
    snap.docs.forEach(function(d){
      var data=d.data();
      if(!attendanceMap[data.dateId])attendanceMap[data.dateId]={};
      attendanceMap[data.dateId][data.studentId]=data.status;
    });
    renderAttendanceTab();
  },function(e){console.error('Attendance:',e);});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll(){ renderDashboard(); renderSanctions(); renderLeaderboard(); renderStudentsTab(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDashboard(){
  var ts=students.reduce(function(s,st){return s+(st.totalSanctions||0);},0);
  var tp=students.reduce(function(s,st){return s+(st.totalPaid||0);},0);
  var to=students.reduce(function(s,st){return s+(st.remainingBalance||0);},0);
  document.getElementById('stat-students').textContent=students.length;
  document.getElementById('stat-sanctions').textContent='â‚±'+ts.toLocaleString();
  document.getElementById('stat-collected').textContent='â‚±'+tp.toLocaleString();
  document.getElementById('stat-outstanding').textContent='â‚±'+to.toLocaleString();
  renderChart();
}
function renderChart(){
  var ctx=document.getElementById('sanctions-chart').getContext('2d');
  var top10=sortedStudents().slice(0,10);
  var dark=document.documentElement.classList.contains('dark');
  var grid=dark?'rgba(255,255,255,.08)':'rgba(0,0,0,.06)';
  var text=dark?'#94a3b8':'#64748b';
  if(sanctionsChart)sanctionsChart.destroy();
  sanctionsChart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:top10.map(function(s){return s.name.split(' ')[0];}),
      datasets:[
        {label:'Sanctions',data:top10.map(function(s){return s.totalSanctions||0;}),backgroundColor:'rgba(249,115,22,.85)',borderRadius:5},
        {label:'Balance',data:top10.map(function(s){return s.remainingBalance||0;}),backgroundColor:'rgba(239,68,68,.65)',borderRadius:5}
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:text,font:{family:'DM Sans',size:11},boxWidth:10}}},
      scales:{
        x:{ticks:{color:text,font:{size:10}},grid:{color:grid}},
        y:{ticks:{color:text,callback:function(v){return 'â‚±'+v;},font:{size:10}},grid:{color:grid}}
      }
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ATTENDANCE TAB  â€” collapsible cards, emoji buttons
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var collapsedDates = {}; // tracks which date cards are collapsed by pd.id

function renderAttendanceTab(){
  var container=document.getElementById('dates-container');
  var noMsg=document.getElementById('no-dates-msg');

  /* Save current collapsed state before wiping */
  container.querySelectorAll('[data-date-id]').forEach(function(bodyEl){
    collapsedDates[bodyEl.dataset.dateId]=bodyEl.classList.contains('collapsed');
  });

  container.innerHTML='';
  if(practiceDates.length===0){noMsg.classList.remove('hidden');return;}
  noMsg.classList.add('hidden');

  practiceDates.slice().reverse().forEach(function(pd){
    var att=attendanceMap[pd.id]||{};

    var card=document.createElement('div');
    card.className='bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden';

    /* Header */
    var hdr=document.createElement('div');
    hdr.className='flex items-center justify-between px-4 py-3 bg-slate-50 dark:bg-slate-700/40 cursor-pointer select-none active:bg-slate-100 dark:active:bg-slate-700 transition';

    var leftGroup=document.createElement('div');
    leftGroup.className='flex items-center gap-2 flex-wrap min-w-0';

    var dateSpan=document.createElement('span');
    dateSpan.className='font-mono font-bold text-brand-500 text-sm';
    dateSpan.textContent=formatDate(pd.date);
    leftGroup.appendChild(dateSpan);

    if(pd.time){
      var tBadge=document.createElement('span');
      tBadge.className='text-xs bg-brand-100 dark:bg-brand-900/40 text-brand-600 dark:text-brand-300 px-2 py-0.5 rounded-lg font-mono';
      tBadge.textContent=formatTime12(pd.time);
      leftGroup.appendChild(tBadge);
    }
    if(pd.sessionLabel){
      var sBadge=document.createElement('span');
      sBadge.className='text-xs bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-200 px-2 py-0.5 rounded-lg font-semibold';
      sBadge.textContent=pd.sessionLabel;
      leftGroup.appendChild(sBadge);
    }
    hdr.appendChild(leftGroup);

    var rightGroup=document.createElement('div');
    rightGroup.className='flex items-center gap-1.5 flex-shrink-0 ml-2';

    /* Summary counts */
    var counts={Present:0,Late:0,Absent:0};
    students.forEach(function(st){var s=att[st.id];if(s&&counts[s]!==undefined)counts[s]++;});
    var sumSpan=document.createElement('span');
    sumSpan.className='text-xs font-mono text-slate-400 whitespace-nowrap';
    sumSpan.textContent='âœ…'+counts.Present+' â°'+counts.Late+' âŒ'+counts.Absent;
    rightGroup.appendChild(sumSpan);

    if(isAdmin){
      var delBtn=document.createElement('button');
      delBtn.className='w-8 h-8 flex items-center justify-center rounded-xl text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 transition text-base';
      delBtn.textContent='ğŸ—‘';
      delBtn.dataset.action='delete-date';
      delBtn.dataset.dateId=pd.id;
      rightGroup.appendChild(delBtn);
    }

    var arrow=document.createElement('span');
    arrow.className='text-slate-400 text-xs transition-transform duration-300 ml-1';
    arrow.textContent='â–¼';
    rightGroup.appendChild(arrow);
    hdr.appendChild(rightGroup);
    card.appendChild(hdr);

    /* Body (collapsible) */
    var body=document.createElement('div');
    body.className='att-body';
    body.dataset.dateId=pd.id; // used to save/restore collapsed state

    /* Restore collapsed state:
       - If never seen before: collapse all except the very first card (index 0 = newest)
       - If seen before: restore whatever the user set */
    var isFirstCard = (container.children.length === 0);
    var isCollapsed;
    if(collapsedDates[pd.id] === undefined){
      isCollapsed = !isFirstCard; // first card open, rest collapsed by default
      collapsedDates[pd.id] = isCollapsed;
    } else {
      isCollapsed = collapsedDates[pd.id];
    }
    if(isCollapsed){
      body.classList.add('collapsed');
      arrow.style.transform='rotate(-90deg)';
    } else {
      body.style.maxHeight='3000px';
    }

    var scrollDiv=document.createElement('div');
    scrollDiv.className='h-scroll';

    var tbl=document.createElement('table');
    tbl.className='w-full min-w-[340px]';
    tbl.style.fontSize='13px';

    var thead=document.createElement('thead');
    var hrow=document.createElement('tr');
    hrow.className='bg-slate-50 dark:bg-slate-700/30';
    [['Student','text-left'],['âœ…','text-center'],['â°','text-center'],['âŒ','text-center']].forEach(function(pair){
      var th=document.createElement('th');
      th.className='px-3 py-2 text-xs font-mono uppercase tracking-widest text-slate-400 '+pair[1];
      th.textContent=pair[0];
      hrow.appendChild(th);
    });
    thead.appendChild(hrow);
    tbl.appendChild(thead);

    var tbody=document.createElement('tbody');
    tbody.className='divide-y divide-slate-100 dark:divide-slate-700/60';

    students.forEach(function(st){
      var status=att[st.id]||null;
      var tr=document.createElement('tr');
      tr.className='hover:bg-slate-50 dark:hover:bg-slate-700/20 transition';

      var nameTd=document.createElement('td');
      nameTd.className='px-3 py-2.5 max-w-[130px]';
      var nameDiv=document.createElement('div');
      nameDiv.className='font-semibold text-sm leading-tight';
      nameDiv.style.wordBreak='break-word';
      nameDiv.textContent=st.name;
      nameTd.appendChild(nameDiv);
      if(st.gradeLevel&&st.gradeLevel!=='Unspecified'){
        var gl=document.createElement('span');
        gl.className='text-xs font-semibold px-1.5 py-0.5 rounded-md '+gradeClass(st.gradeLevel);
        gl.style.fontSize='10px';
        gl.textContent=st.gradeLevel==='Grade 11'?'G11':'G12';
        nameTd.appendChild(gl);
      }
      tr.appendChild(nameTd);

      ['Present','Late','Absent'].forEach(function(v){
        var tdEl=document.createElement('td');
        tdEl.className='px-2 py-2 text-center';
        var icons={Present:'âœ…',Late:'â°',Absent:'âŒ'};
        var btn=document.createElement('button');
        btn.textContent=icons[v];
        btn.dataset.action='mark';
        btn.dataset.dateId=pd.id;
        btn.dataset.studentId=st.id;
        btn.dataset.status=v;
        var sel=status===v;
        btn.className='w-10 h-10 rounded-xl text-lg transition-all '+(sel?'bg-brand-100 dark:bg-brand-900/40 ring-2 ring-brand-400 scale-110 shadow-sm':'opacity-30 hover:opacity-70 hover:bg-slate-100 dark:hover:bg-slate-700');
        btn.style.minHeight='0';
        if(!isAdmin){btn.disabled=true;btn.style.cursor='not-allowed';}
        tdEl.appendChild(btn);
        tr.appendChild(tdEl);
      });

      tbody.appendChild(tr);
    });

    tbl.appendChild(tbody);
    scrollDiv.appendChild(tbl);
    body.appendChild(scrollDiv);
    card.appendChild(body);
    container.appendChild(card);

    /* Collapse toggle */
    hdr.addEventListener('click',function(e){
      if(e.target.closest('[data-action]'))return;
      var collapsed=body.classList.toggle('collapsed');
      arrow.style.transform=collapsed?'rotate(-90deg)':'';
      if(!collapsed)body.style.maxHeight='3000px';
      collapsedDates[pd.id]=collapsed;
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD / DELETE PRACTICE DATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function addPracticeDate(){
  if(!isAdmin){toast('Admin access required.','error');return;}
  var val=document.getElementById('new-date-input').value;
  var time=document.getElementById('new-time-input').value;
  var label=document.getElementById('new-session-label').value.trim();
  if(!val){toast('Select a date first.','error');return;}
  var dup=practiceDates.some(function(p){return p.date===val&&(p.time||'')===time&&(p.sessionLabel||'')===label;});
  if(dup){toast('This exact session already exists.','error');return;}
  try{
    var payload={date:val};
    if(time)payload.time=time;
    if(label)payload.sessionLabel=label;
    await db.collection('practiceDates').add(payload);
    document.getElementById('new-time-input').value='';
    document.getElementById('new-session-label').value='';
    toast('Session added!','success');
  }catch(e){console.error(e);toast('Error: '+e.message,'error');}
}

async function deletePracticeDate(dateId){
  openConfirm('Delete this session and all its attendance records?',async function(){
    try{
      var snap=await db.collection('attendance').where('dateId','==',dateId).get();
      var affected=[];
      snap.docs.forEach(function(d){var sid=d.data().studentId;if(affected.indexOf(sid)===-1)affected.push(sid);});
      if(!snap.empty){var batch=db.batch();snap.docs.forEach(function(d){batch.delete(d.ref);});await batch.commit();}
      await db.collection('practiceDates').doc(dateId).delete();
      for(var i=0;i<affected.length;i++)await recalcStudent(affected[i]);
      toast('Session deleted.','info');
    }catch(e){console.error(e);toast('Error: '+e.message,'error');}
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARK ATTENDANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function markAttendance(dateId,studentId,status){
  if(!isAdmin){toast('Admin access required.','error');return;}
  try{
    var snap=await db.collection('attendance').where('dateId','==',dateId).where('studentId','==',studentId).get();
    if(snap.empty){await db.collection('attendance').add({dateId:dateId,studentId:studentId,status:status});}
    else{await snap.docs[0].ref.update({status:status});}
    await recalcStudent(studentId);
    toast('Marked '+status,'success');
  }catch(e){console.error(e);toast('Error: '+e.message,'error');}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECALC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function recalcStudent(studentId){
  try{
    var snap=await db.collection('attendance').where('studentId','==',studentId).get();
    var late=0,absent=0;
    snap.docs.forEach(function(d){var s=d.data().status;if(s==='Late')late++;if(s==='Absent')absent++;});
    var sanctions=(late*10)+(absent*50);
    var stuDoc=await db.collection('students').doc(studentId).get();
    var paid=stuDoc.exists?(stuDoc.data().totalPaid||0):0;
    var balance=Math.max(0,sanctions-paid);
    await db.collection('students').doc(studentId).update({totalLate:late,totalAbsent:absent,totalSanctions:sanctions,remainingBalance:balance});
  }catch(e){console.error('Recalc:',e);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SANCTIONS  â€” mobile card layout
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSanctions(){
  var list=document.getElementById('sanctions-list');
  var searchEl=document.getElementById('sanctions-search');
  var query=searchEl?searchEl.value.trim().toLowerCase():'';
  var sorted=sortedStudents().filter(function(st){
    if(snGradeFilter!=='all'&&(st.gradeLevel||'Unspecified')!==snGradeFilter)return false;
    if(query&&st.name.toLowerCase().indexOf(query)===-1)return false;
    var cleared=(st.remainingBalance||0)===0&&(st.totalSanctions||0)>0;
    if(snStatusFilter==='late'&&!(st.totalLate||0))return false;
    if(snStatusFilter==='absent'&&!(st.totalAbsent||0))return false;
    if(snStatusFilter==='balance'&&!(st.remainingBalance||0))return false;
    if(snStatusFilter==='cleared'&&!cleared)return false;
    return true;
  });
  list.innerHTML='';
  if(sorted.length===0){list.innerHTML='<p class="text-center py-10 text-slate-400 font-mono text-sm">No students yet.</p>';return;}

  sorted.forEach(function(st,i){
    var cleared=(st.remainingBalance||0)===0&&(st.totalSanctions||0)>0;
    var card=document.createElement('div');
    card.className='bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm p-4 cursor-pointer active:scale-[.98] transition-transform';
    card.addEventListener('click',function(e){
      if(e.target.closest('[data-action]'))return;
      openStudentProfile(st.id);
    });

    /* Top row: name + status */
    var topRow=document.createElement('div');
    topRow.className='flex items-start justify-between gap-2 mb-3';

    var nameBlock=document.createElement('div');
    var nameRow=document.createElement('div');
    nameRow.className='flex items-center gap-1.5 flex-wrap';
    nameRow.innerHTML='<span class="text-xs font-mono text-slate-400">#'+(i+1)+'</span><span class="font-bold text-sm">'+escHtml(st.name)+'</span><span class="text-xs text-slate-300 dark:text-slate-600 ml-1">â†—</span>';
    nameBlock.appendChild(nameRow);
    if(st.gradeLevel){
      var gl=document.createElement('span');
      gl.className='inline-block mt-1 text-xs font-semibold px-2 py-0.5 rounded-lg '+gradeClass(st.gradeLevel);
      gl.textContent=st.gradeLevel;
      nameBlock.appendChild(gl);
    }
    topRow.appendChild(nameBlock);

    var statusBadge=document.createElement('span');
    statusBadge.className=(cleared?'badge-cleared':'badge-balance')+' text-xs font-bold px-2.5 py-1 rounded-xl flex-shrink-0';
    statusBadge.textContent=cleared?'Cleared':'Balance';
    topRow.appendChild(statusBadge);
    card.appendChild(topRow);

    /* Stats grid */
    var grid=document.createElement('div');
    grid.className='grid grid-cols-4 gap-2 mb-3';
    [
      {label:'Late',val:st.totalLate||0,cls:'text-amber-500'},
      {label:'Absent',val:st.totalAbsent||0,cls:'text-red-500'},
      {label:'Paid',val:'â‚±'+(st.totalPaid||0).toLocaleString(),cls:'text-green-600'},
      {label:'Balance',val:'â‚±'+(st.remainingBalance||0).toLocaleString(),cls:'text-red-500 font-bold'},
    ].forEach(function(item){
      var box=document.createElement('div');
      box.className='bg-slate-50 dark:bg-slate-700/50 rounded-xl p-2 text-center';
      box.innerHTML='<div class="text-xs text-slate-400 leading-tight mb-0.5">'+item.label+'</div><div class="text-xs font-mono font-semibold '+item.cls+'">'+item.val+'</div>';
      grid.appendChild(box);
    });
    card.appendChild(grid);

    if(isAdmin){
      var payBtn=document.createElement('button');
      payBtn.className='w-full py-2.5 rounded-xl bg-green-500 text-white text-sm font-bold hover:bg-green-600 transition';
      payBtn.textContent='ğŸ’³ Record Payment';
      payBtn.dataset.action='pay';
      payBtn.dataset.id=st.id;
      payBtn.dataset.name=st.name;
      card.appendChild(payBtn);
    }

    list.appendChild(card);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENT PROFILE MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var profileStudentId = null;

function openStudentProfile(studentId){
  var st=students.find(function(s){return s.id===studentId;});
  if(!st)return;
  profileStudentId=studentId;

  /* Name */
  document.getElementById('profile-name').textContent=st.name;

  /* Meta (grade pill) */
  var metaEl=document.getElementById('profile-meta');
  metaEl.innerHTML='';
  if(st.gradeLevel){
    var gl=document.createElement('span');
    gl.className='text-xs font-semibold px-2 py-0.5 rounded-lg '+gradeClass(st.gradeLevel);
    gl.textContent=st.gradeLevel;
    metaEl.appendChild(gl);
  }
  var cleared=(st.remainingBalance||0)===0&&(st.totalSanctions||0)>0;
  var badge=document.createElement('span');
  badge.className=(cleared?'badge-cleared':'badge-balance')+' text-xs font-bold px-2 py-0.5 rounded-lg';
  badge.textContent=cleared?'Cleared':'With Balance';
  metaEl.appendChild(badge);

  /* Summary pills */
  var summaryEl=document.getElementById('profile-summary');
  summaryEl.innerHTML='';
  [
    {label:'Late',val:st.totalLate||0,cls:'text-amber-500'},
    {label:'Absent',val:st.totalAbsent||0,cls:'text-red-500'},
    {label:'Paid',val:'â‚±'+(st.totalPaid||0).toLocaleString(),cls:'text-green-600'},
    {label:'Balance',val:'â‚±'+(st.remainingBalance||0).toLocaleString(),cls:'text-red-500 font-bold'},
  ].forEach(function(item){
    var box=document.createElement('div');
    box.className='bg-slate-50 dark:bg-slate-700/50 rounded-xl p-2 text-center';
    box.innerHTML='<div class="text-xs text-slate-400 leading-tight mb-0.5">'+item.label+'</div><div class="text-xs font-mono font-semibold '+item.cls+'">'+item.val+'</div>';
    summaryEl.appendChild(box);
  });

  /* Reset tab to All */
  document.querySelectorAll('.profile-tab-btn').forEach(function(b){
    b.classList.remove('active','border-brand-500','text-brand-500');
    b.classList.add('border-transparent','text-slate-400');
  });
  var firstTab=document.querySelector('.profile-tab-btn[data-ptab="all"]');
  if(firstTab){firstTab.classList.add('active','border-brand-500','text-brand-500');firstTab.classList.remove('border-transparent','text-slate-400');}

  renderProfileRecords('all');
  showModal('profile-modal');
}

function renderProfileRecords(tabFilter){
  var container=document.getElementById('profile-records');
  container.innerHTML='';

  /* Build list of {date, sessionLabel, time, status} for this student */
  var records=[];
  practiceDates.forEach(function(pd){
    var status=(attendanceMap[pd.id]&&attendanceMap[pd.id][profileStudentId])||'Present';
    records.push({date:pd.date,time:pd.time||'',sessionLabel:pd.sessionLabel||'',status:status});
  });

  /* Sort newest first */
  records.sort(function(a,b){return b.date.localeCompare(a.date);});

  /* Filter by tab */
  var filtered=records.filter(function(r){
    if(tabFilter==='all')return true;
    if(tabFilter==='late')return r.status==='Late';
    if(tabFilter==='absent')return r.status==='Absent';
    if(tabFilter==='present')return r.status==='Present';
    return true;
  });

  if(filtered.length===0){
    container.innerHTML='<p class="text-center py-8 text-slate-400 font-mono text-sm">No records here.</p>';
    return;
  }

  filtered.forEach(function(r){
    var statusIcon=r.status==='Late'?'â°':r.status==='Absent'?'âŒ':'âœ…';
    var statusCls=r.status==='Late'?'text-amber-500 bg-amber-50 dark:bg-amber-900/20':r.status==='Absent'?'text-red-500 bg-red-50 dark:bg-red-900/20':'text-green-600 bg-green-50 dark:bg-green-900/20';
    var row=document.createElement('div');
    row.className='flex items-center justify-between gap-2 bg-slate-50 dark:bg-slate-700/40 rounded-xl px-3 py-2.5';

    var left=document.createElement('div');
    left.className='min-w-0';
    var dateStr='<span class="font-mono font-bold text-sm text-slate-700 dark:text-slate-200">'+formatDate(r.date)+'</span>';
    var sub='';
    if(r.time)sub+='<span class="text-xs text-slate-400 font-mono">'+formatTime12(r.time)+'</span>';
    if(r.sessionLabel)sub+=(sub?' Â· ':'')+'<span class="text-xs text-slate-400">'+escHtml(r.sessionLabel)+'</span>';
    left.innerHTML=dateStr+(sub?'<div class="flex gap-1 mt-0.5">'+sub+'</div>':'');

    var right=document.createElement('span');
    right.className='text-xs font-bold px-2.5 py-1 rounded-xl flex-shrink-0 '+statusCls;
    right.textContent=statusIcon+' '+r.status;

    row.appendChild(left);
    row.appendChild(right);
    container.appendChild(row);
  });
}


function renderLeaderboard(){
  var list=document.getElementById('leaderboard-list');
  var sorted=sortedStudents().filter(function(st){
    if(lbGradeFilter==='all')return true;
    return(st.gradeLevel||'Unspecified')===lbGradeFilter;
  });
  list.innerHTML='';
  if(sorted.length===0){list.innerHTML='<p class="text-center py-10 text-slate-400 font-mono text-sm">No students here.</p>';return;}

  var medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  sorted.forEach(function(st,i){
    var cleared=(st.remainingBalance||0)===0&&(st.totalSanctions||0)>0;
    var card=document.createElement('div');
    card.className='bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm p-4 flex items-center gap-3';

    var rankDiv=document.createElement('div');
    rankDiv.className='text-2xl w-10 text-center flex-shrink-0 leading-none';
    rankDiv.textContent=i<3?medals[i]:'#'+(i+1);
    card.appendChild(rankDiv);

    var info=document.createElement('div');
    info.className='flex-1 min-w-0';

    var nameRow=document.createElement('div');
    nameRow.className='flex items-center gap-1.5 flex-wrap mb-1';
    var nameSpan=document.createElement('span');
    nameSpan.className='font-bold text-sm';
    nameSpan.textContent=st.name;
    nameRow.appendChild(nameSpan);
    if(st.gradeLevel){
      var gl=document.createElement('span');
      gl.className='text-xs font-bold px-1.5 py-0.5 rounded-md '+gradeClass(st.gradeLevel);
      gl.style.fontSize='10px';
      gl.textContent=st.gradeLevel==='Grade 11'?'G11':st.gradeLevel==='Grade 12'?'G12':'?';
      nameRow.appendChild(gl);
    }
    info.appendChild(nameRow);

    var statsRow=document.createElement('div');
    statsRow.className='flex items-center gap-3 text-xs font-mono text-slate-500 flex-wrap';
    statsRow.innerHTML='<span class="text-amber-500">â° '+(st.totalLate||0)+'</span>'+'<span class="text-red-500">âŒ '+(st.totalAbsent||0)+'</span>'+'<span>â‚±'+(st.totalSanctions||0).toLocaleString()+'</span>';
    info.appendChild(statsRow);
    card.appendChild(info);

    var statusBadge=document.createElement('span');
    var label=cleared?'Cleared':(st.remainingBalance||0)>0?'â‚±'+(st.remainingBalance||0).toLocaleString():'â€”';
    statusBadge.className=(cleared?'badge-cleared':'badge-balance')+' text-xs font-bold px-2.5 py-1 rounded-xl flex-shrink-0';
    statusBadge.textContent=label;
    card.appendChild(statusBadge);

    list.appendChild(card);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENTS  â€” mobile cards + grade filter
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStudentsTab(){
  var list=document.getElementById('students-list');
  var query=(document.getElementById('student-search').value||'').toLowerCase();
  var filtered=students.filter(function(s){
    var nm=!query||s.name.toLowerCase().includes(query);
    var gm=stGradeFilter==='all'||(s.gradeLevel||'Unspecified')===stGradeFilter;
    return nm&&gm;
  });
  list.innerHTML='';
  if(filtered.length===0){list.innerHTML='<p class="text-center py-10 text-slate-400 font-mono text-sm">'+(query?'No students match.':'No students yet.')+'</p>';return;}

  filtered.forEach(function(st,i){
    var card=document.createElement('div');
    card.className='bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm p-4';

    var topRow=document.createElement('div');
    topRow.className='flex items-start justify-between gap-2 mb-3';

    var nameBlock=document.createElement('div');
    var nameRow=document.createElement('div');
    nameRow.className='flex items-center gap-1.5 flex-wrap';
    nameRow.innerHTML='<span class="text-xs font-mono text-slate-400">#'+(i+1)+'</span><span class="font-bold text-sm">'+escHtml(st.name)+'</span>';
    nameBlock.appendChild(nameRow);
    if(st.gradeLevel){
      var gl=document.createElement('span');
      gl.className='inline-block mt-1 text-xs font-semibold px-2 py-0.5 rounded-lg '+gradeClass(st.gradeLevel);
      gl.textContent=st.gradeLevel;
      nameBlock.appendChild(gl);
    }
    topRow.appendChild(nameBlock);

    var acts=document.createElement('div');
    acts.className='flex gap-1.5 flex-shrink-0';

    var editBtn=document.createElement('button');
    editBtn.className='px-3 py-1.5 rounded-xl border border-slate-200 dark:border-slate-600 text-sm font-bold hover:bg-slate-100 dark:hover:bg-slate-700 transition';
    editBtn.textContent='âœï¸';
    editBtn.style.minHeight='0';
    editBtn.dataset.action='edit';
    editBtn.dataset.id=st.id;
    editBtn.dataset.name=st.name;

    var delBtn=document.createElement('button');
    delBtn.className='px-3 py-1.5 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-500 text-sm font-bold hover:bg-red-100 transition';
    delBtn.textContent='ğŸ—‘';
    delBtn.style.minHeight='0';
    delBtn.dataset.action='delete';
    delBtn.dataset.id=st.id;
    delBtn.dataset.name=st.name;

    acts.appendChild(editBtn);
    acts.appendChild(delBtn);
    topRow.appendChild(acts);
    card.appendChild(topRow);

    var statsRow=document.createElement('div');
    statsRow.className='grid grid-cols-3 gap-2';
    [
      {label:'Absences',val:st.totalAbsent||0,cls:'text-red-500'},
      {label:'Late',val:st.totalLate||0,cls:'text-amber-500'},
      {label:'Balance',val:'â‚±'+(st.remainingBalance||0).toLocaleString(),cls:'text-red-500 font-bold'},
    ].forEach(function(item){
      var box=document.createElement('div');
      box.className='bg-slate-50 dark:bg-slate-700/50 rounded-xl p-2 text-center';
      box.innerHTML='<div class="text-xs text-slate-400 mb-0.5">'+item.label+'</div><div class="text-sm font-mono font-semibold '+item.cls+'">'+item.val+'</div>';
      statsRow.appendChild(box);
    });
    card.appendChild(statsRow);
    list.appendChild(card);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openAddStudent(){
  editingStudentId=null;
  document.getElementById('student-modal-title').textContent='Add Student';
  document.getElementById('student-name-input').value='';
  document.getElementById('student-grade-input').value='Unspecified';
  setGradePickerUI('Unspecified');
  document.getElementById('edit-sanctions-section').classList.add('hidden');
  showModal('student-modal');
  setTimeout(function(){document.getElementById('student-name-input').focus();},100);
}

function openEditStudent(id,name){
  editingStudentId=id;
  document.getElementById('student-modal-title').textContent='Edit Student';
  document.getElementById('student-name-input').value=name;
  document.getElementById('edit-sanctions-section').classList.remove('hidden');
  var st=students.find(function(s){return s.id===id;});
  if(st){
    document.getElementById('edit-late-input').value=st.totalLate||0;
    document.getElementById('edit-absent-input').value=st.totalAbsent||0;
    document.getElementById('edit-paid-input').value=st.totalPaid||0;
    var gl=st.gradeLevel||'Unspecified';
    document.getElementById('student-grade-input').value=gl;
    setGradePickerUI(gl);
    updateSanctionPreview();
  }
  showModal('student-modal');
  setTimeout(function(){document.getElementById('student-name-input').focus();},100);
}

function setGradePickerUI(level){
  document.querySelectorAll('.grade-btn').forEach(function(btn){
    btn.classList.remove('sel-g11','sel-g12','sel-un');
    if(btn.dataset.level===level){
      if(level==='Grade 11')btn.classList.add('sel-g11');
      else if(level==='Grade 12')btn.classList.add('sel-g12');
      else btn.classList.add('sel-un');
    }
  });
}

function updateSanctionPreview(){
  var late=parseInt(document.getElementById('edit-late-input').value)||0;
  var absent=parseInt(document.getElementById('edit-absent-input').value)||0;
  var paid=parseFloat(document.getElementById('edit-paid-input').value)||0;
  var sanctions=(late*10)+(absent*50);
  var balance=Math.max(0,sanctions-paid);
  document.getElementById('edit-sanction-preview').innerHTML=
    'LateÃ—â‚±10 + AbsentÃ—â‚±50 = <strong>â‚±'+sanctions.toLocaleString()+'</strong> | Paid: <strong>â‚±'+paid.toLocaleString()+'</strong> | Balance: <strong class="text-red-400">â‚±'+balance.toLocaleString()+'</strong>';
}

async function submitStudent(){
  var name=document.getElementById('student-name-input').value.trim();
  var grade=document.getElementById('student-grade-input').value||'Unspecified';
  if(!name){toast('Name is required.','error');return;}
  try{
    if(editingStudentId){
      var late=parseInt(document.getElementById('edit-late-input').value)||0;
      var absent=parseInt(document.getElementById('edit-absent-input').value)||0;
      var paid=parseFloat(document.getElementById('edit-paid-input').value)||0;
      var sanctions=(late*10)+(absent*50);
      var balance=Math.max(0,sanctions-paid);
      await db.collection('students').doc(editingStudentId).update({name:name,gradeLevel:grade,totalLate:late,totalAbsent:absent,totalSanctions:sanctions,totalPaid:paid,remainingBalance:balance});
      toast('Student updated!','success');
    } else {
      await db.collection('students').add({name:name,gradeLevel:grade,totalLate:0,totalAbsent:0,totalSanctions:0,totalPaid:0,remainingBalance:0});
      toast('Student added!','success');
    }
    hideModal('student-modal');
  }catch(e){console.error(e);toast('Error: '+e.message,'error');}
}

async function resetStudentSanctions(id){
  openConfirm('Reset ALL sanctions for this student to zero?',async function(){
    try{
      await db.collection('students').doc(id).update({totalLate:0,totalAbsent:0,totalSanctions:0,totalPaid:0,remainingBalance:0});
      var snap=await db.collection('attendance').where('studentId','==',id).get();
      if(!snap.empty){var batch=db.batch();snap.docs.forEach(function(d){batch.delete(d.ref);});await batch.commit();}
      hideModal('student-modal');
      toast('Sanctions reset to zero.','info');
    }catch(e){console.error(e);toast('Error: '+e.message,'error');}
  });
}

async function deleteStudent(id,name){
  openConfirm('Delete student "'+name+'"? All attendance will be removed too.',async function(){
    try{
      var snap=await db.collection('attendance').where('studentId','==',id).get();
      if(!snap.empty){var batch=db.batch();snap.docs.forEach(function(d){batch.delete(d.ref);});await batch.commit();}
      await db.collection('students').doc(id).delete();
      toast('Student deleted.','info');
    }catch(e){console.error(e);toast('Error: '+e.message,'error');}
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAYMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPaymentModal(id,name){
  payingStudentId=id;
  document.getElementById('payment-name').textContent=name;
  document.getElementById('payment-amount').value='';
  showModal('payment-modal');
  setTimeout(function(){document.getElementById('payment-amount').focus();},100);
}

async function submitPayment(){
  var amount=parseFloat(document.getElementById('payment-amount').value);
  if(!amount||amount<=0){toast('Enter a valid amount.','error');return;}
  try{
    var doc=await db.collection('students').doc(payingStudentId).get();
    if(!doc.exists){toast('Student not found.','error');return;}
    var data=doc.data();
    var newPaid=(data.totalPaid||0)+amount;
    var newBal=Math.max(0,(data.totalSanctions||0)-newPaid);
    await db.collection('students').doc(payingStudentId).update({totalPaid:newPaid,remainingBalance:newBal});
    toast('Payment of â‚±'+amount+' recorded!','success');
    hideModal('payment-modal');
  }catch(e){console.error(e);toast('Error: '+e.message,'error');}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openResetAllModal(){
  if(!isAdmin){toast('Admin access required.','error');return;}
  document.getElementById('reset-all-password').value='';
  document.getElementById('reset-all-error').classList.add('hidden');
  showModal('reset-all-modal');
  setTimeout(function(){document.getElementById('reset-all-password').focus();},100);
}

async function submitResetAll(){
  var pwd=document.getElementById('reset-all-password').value;
  if(pwd!=='@EcoreEst2021'){
    document.getElementById('reset-all-error').classList.remove('hidden');
    document.getElementById('reset-all-password').value='';
    document.getElementById('reset-all-password').focus();
    return;
  }
  document.getElementById('reset-all-error').classList.add('hidden');
  hideModal('reset-all-modal');
  showLoading();
  try{
    var a=await db.collection('attendance').get();
    if(!a.empty){var b1=db.batch();a.docs.forEach(function(d){b1.delete(d.ref);});await b1.commit();}
    var p=await db.collection('practiceDates').get();
    if(!p.empty){var b2=db.batch();p.docs.forEach(function(d){b2.delete(d.ref);});await b2.commit();}
    var s=await db.collection('students').get();
    if(!s.empty){var b3=db.batch();s.docs.forEach(function(d){b3.update(d.ref,{totalLate:0,totalAbsent:0,totalSanctions:0,totalPaid:0,remainingBalance:0});});await b3.commit();}
    toast('All records reset.','info');
  }catch(e){console.error(e);toast('Error: '+e.message,'error');}
  hideLoading();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVENT DELEGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onAttendanceClick(e){
  var btn=e.target.closest('[data-action]');if(!btn)return;
  if(btn.dataset.action==='delete-date')deletePracticeDate(btn.dataset.dateId);
  else if(btn.dataset.action==='mark')markAttendance(btn.dataset.dateId,btn.dataset.studentId,btn.dataset.status);
}
function onSanctionsClick(e){
  var btn=e.target.closest('[data-action]');if(!btn)return;
  if(btn.dataset.action==='pay')openPaymentModal(btn.dataset.id,btn.dataset.name);
}
function onStudentsClick(e){
  var btn=e.target.closest('[data-action]');if(!btn)return;
  if(btn.dataset.action==='edit')openEditStudent(btn.dataset.id,btn.dataset.name);
  if(btn.dataset.action==='delete')deleteStudent(btn.dataset.id,btn.dataset.name);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT CSV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportCSV(){
  var rows=[['Rank','Name','Grade Level','Late','Absent','Sanctions','Paid','Balance','Status']];
  sortedStudents().forEach(function(st,i){
    var cleared=(st.remainingBalance||0)===0&&(st.totalSanctions||0)>0;
    rows.push([i+1,st.name,st.gradeLevel||'Unspecified',st.totalLate||0,st.totalAbsent||0,st.totalSanctions||0,st.totalPaid||0,st.remainingBalance||0,cleared?'Cleared':'With Balance']);
  });
  var csv=rows.map(function(r){return r.map(function(c){return '"'+String(c).replace(/"/g,'""')+'"';}).join(',');}).join('\r\n');
  var blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;a.download='sanctions_'+new Date().toISOString().split('T')[0]+'.csv';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('CSV exported!','success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM HELPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openConfirm(text,cb){
  document.getElementById('confirm-text').textContent=text;
  pendingConfirm=cb;
  showModal('confirm-modal');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SORTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sortedStudents(){
  return students.slice().sort(function(a,b){
    var d=(b.totalSanctions||0)-(a.totalSanctions||0);if(d)return d;
    d=(b.totalAbsent||0)-(a.totalAbsent||0);if(d)return d;
    return(b.totalLate||0)-(a.totalLate||0);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(name){
  document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.nav-tab').forEach(function(t){t.classList.remove('active');});
  document.getElementById('tab-'+name).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(function(t){if(t.dataset.tab===name)t.classList.add('active');});
  if(name==='dashboard')setTimeout(renderChart,80);
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showModal(id){document.getElementById(id).classList.remove('hidden');}
function hideModal(id){document.getElementById(id).classList.add('hidden');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg,type){
  var el=document.createElement('div');
  el.className='toast '+(type||'info');
  el.textContent=msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(function(){el.style.animation='fadeOut .3s ease forwards';setTimeout(function(){el.remove();},300);},3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLoading(){document.getElementById('loading-overlay').style.display='flex';}
function hideLoading(){document.getElementById('loading-overlay').style.display='none';}
function showApp(){document.getElementById('app').classList.remove('hidden');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function formatDate(s){
  if(!s)return'';
  var p=s.split('-');
  return new Date(p[0],p[1]-1,p[2]).toLocaleDateString('en-PH',{year:'numeric',month:'short',day:'numeric'});
}
function formatTime12(t){
  if(!t)return'';
  var parts=t.split(':');
  var h=parseInt(parts[0],10);var m=parts[1];
  var ampm=h>=12?'PM':'AM';
  h=((h%12)||12);
  return h+':'+m+' '+ampm;
}
function gradeClass(level){
  if(level==='Grade 11')return'pill-g11';
  if(level==='Grade 12')return'pill-g12';
  return'pill-unspec';
}
function escHtml(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
<!--
=================================================================
FIRESTORE SECURITY RULES
Firebase Console > Firestore > Rules > Paste > Publish
=================================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /students/{docId}      { allow read: if true; allow write: if request.auth != null; }
    match /practiceDates/{docId} { allow read: if true; allow write: if request.auth != null; }
    match /attendance/{docId}    { allow read: if true; allow write: if request.auth != null; }
  }
}
-->
</body>
</html>
